---
interface Props {
  proposalId: string;
  correctPassword?: string;
}

const { proposalId, correctPassword } = Astro.props;
const hasPassword = !!correctPassword;
---

{hasPassword ? (
  <>
    <div id="password-prompt" class="password-prompt-wrapper" transition:persist>
      <div class="password-prompt-card">
        <h2 class="password-prompt-title">Este documento é protegido</h2>
        <p class="password-prompt-text">
          Insira a senha para visualizar.
        </p>
        <form id="password-form" class="password-form">
          <div>
            <label for="password-input" class="password-label">
              Senha de acesso
            </label>
            <input
              type="password"
              id="password-input"
              class="password-input"
              placeholder="••••••••"
              required
            />
          </div>
          <div id="error-message" class="password-error">
            Senha incorreta. Verifique e tente novamente.
          </div>
          <button
            type="submit"
            class="password-submit"
          >
            Acessar documento
          </button>
        </form>
      </div>
    </div>

    <div id="proposal-content" class="hidden" transition:persist data-astro-transition="none">
      <slot />
    </div>

    <script define:vars={{ proposalId, correctPassword }}>
      const STORAGE_KEY = `proposal_unlocked_${proposalId}`;

      // Check if already unlocked
      function checkUnlocked() {
        const unlocked = sessionStorage.getItem(STORAGE_KEY);
        if (unlocked === 'true') {
          showContent();
        }
      }

      function showContent() {
        document.getElementById('password-prompt')?.classList.add('hidden');
        document.getElementById('proposal-content')?.classList.remove('hidden');
      }

      function showError() {
        document.getElementById('error-message')?.classList.remove('hidden');
      }

      function hideError() {
        document.getElementById('error-message')?.classList.add('hidden');
      }

      // Handle form submission
      document.getElementById('password-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        hideError();

        const input = document.getElementById('password-input');
        const enteredPassword = input?.value;

        if (enteredPassword === correctPassword) {
          sessionStorage.setItem(STORAGE_KEY, 'true');
          showContent();
        } else {
          showError();
          if (input) {
            input.value = '';
            input.focus();
          }
        }
      });

      // Check on page load
      checkUnlocked();
    </script>

    <style>
      .password-prompt-wrapper {
        max-width: 28rem;
        margin: 0 auto;
        padding: 6rem 1rem;
      }

      .password-prompt-card {
        background: white;
        border: 1px solid var(--color-stroke, #E5E5E5);
        border-radius: 12px;
        padding: 2.5rem;
      }

      .password-prompt-title {
        font-family: 'Archivo Variable', sans-serif;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text, #1A1A1A);
        margin: 0 0 0.75rem 0;
      }

      .password-prompt-text {
        font-family: 'Archivo Variable', sans-serif;
        font-size: 0.9375rem;
        line-height: 1.6;
        color: var(--color-text, #1A1A1A);
        opacity: 0.7;
        margin: 0 0 2rem 0;
      }

      .password-form {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .password-label {
        display: block;
        font-family: 'Archivo Variable', sans-serif;
        font-size: 0.8125rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text, #1A1A1A);
        opacity: 0.6;
        margin-bottom: 0.5rem;
      }

      .password-input {
        width: 100%;
        font-family: 'Archivo Variable', sans-serif;
        font-size: 0.9375rem;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--color-stroke, #E5E5E5);
        border-radius: 6px;
        background: white;
        transition: border-color 0.15s ease;
      }

      .password-input:focus {
        outline: none;
        border-color: var(--color-text, #1A1A1A);
      }

      .password-error {
        display: none;
        font-family: 'Archivo Variable', sans-serif;
        font-size: 0.875rem;
        color: #DC2626;
        margin: -0.5rem 0 0 0;
      }

      .password-submit {
        width: 100%;
        font-family: 'Archivo Variable', sans-serif;
        font-size: 0.9375rem;
        font-weight: 600;
        padding: 0.75rem 1rem;
        background: var(--color-text, #1A1A1A);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: opacity 0.15s ease;
      }

      .password-submit:hover {
        opacity: 0.9;
      }

      .password-submit:focus {
        outline: 2px solid var(--color-text, #1A1A1A);
        outline-offset: 2px;
      }
    </style>
  </>
) : (
  <slot />
)}
