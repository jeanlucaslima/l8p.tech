---
interface Props {
  proposalId: string;
  correctPassword: string;
}

const { proposalId, correctPassword } = Astro.props;
---

<div id="password-prompt" class="mx-auto max-w-md px-4 py-16">
  <div class="rounded-lg border border-gray-200 bg-white p-8 shadow-sm">
    <h2 class="mb-4 text-2xl font-bold text-gray-900">Proposta Protegida</h2>
    <p class="mb-6 text-sm text-gray-600">
      Esta proposta requer uma senha para visualização. Por favor, insira a senha fornecida.
    </p>
    <form id="password-form" class="space-y-4">
      <div>
        <label for="password-input" class="block text-sm font-medium text-gray-700 mb-2">
          Senha
        </label>
        <input
          type="password"
          id="password-input"
          class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Digite a senha"
          required
        />
      </div>
      <div id="error-message" class="hidden rounded-lg bg-red-50 p-3 text-sm text-red-800">
        Senha incorreta. Por favor, tente novamente.
      </div>
      <button
        type="submit"
        class="w-full rounded-lg bg-blue-600 px-4 py-2 font-medium text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        Desbloquear
      </button>
    </form>
  </div>
</div>

<div id="proposal-content" class="hidden">
  <slot />
</div>

<script define:vars={{ proposalId, correctPassword }}>
  const STORAGE_KEY = `proposal_unlocked_${proposalId}`;

  // Check if already unlocked
  function checkUnlocked() {
    const unlocked = sessionStorage.getItem(STORAGE_KEY);
    if (unlocked === 'true') {
      showContent();
    }
  }

  function showContent() {
    document.getElementById('password-prompt')?.classList.add('hidden');
    document.getElementById('proposal-content')?.classList.remove('hidden');
  }

  function showError() {
    document.getElementById('error-message')?.classList.remove('hidden');
  }

  function hideError() {
    document.getElementById('error-message')?.classList.add('hidden');
  }

  // Handle form submission
  document.getElementById('password-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    hideError();

    const input = document.getElementById('password-input');
    const enteredPassword = input?.value;

    if (enteredPassword === correctPassword) {
      sessionStorage.setItem(STORAGE_KEY, 'true');
      showContent();
    } else {
      showError();
      if (input) {
        input.value = '';
        input.focus();
      }
    }
  });

  // Check on page load
  checkUnlocked();
</script>
