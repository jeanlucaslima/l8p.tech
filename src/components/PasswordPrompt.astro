---
interface Props {
  proposalId: string;
  correctPassword: string;
}

const { proposalId, correctPassword } = Astro.props;
---

<div id="password-prompt" class="mx-auto max-w-md px-4 py-24">
  <div class="rounded-sm border border-gray-200 bg-white p-10">
    <h2 class="mb-3 text-lg font-semibold text-gray-900">Este documento está protegido</h2>
    <p class="mb-8 text-sm leading-relaxed text-gray-500">
      Insira a senha de acesso para visualizar esta proposta.
    </p>
    <form id="password-form" class="space-y-5">
      <div>
        <label for="password-input" class="mb-2 block text-xs font-medium uppercase tracking-wide text-gray-400">
          Senha de acesso
        </label>
        <input
          type="password"
          id="password-input"
          class="w-full rounded-sm border border-gray-300 bg-white px-4 py-2.5 text-sm transition-colors focus:border-gray-400 focus:outline-none focus:ring-0"
          placeholder="••••••••"
          required
        />
      </div>
      <div id="error-message" class="hidden text-sm text-red-600">
        Senha incorreta. Verifique e tente novamente.
      </div>
      <button
        type="submit"
        class="w-full rounded-sm bg-gray-900 px-4 py-2.5 text-sm font-medium text-white transition-opacity hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2"
      >
        Acessar documento
      </button>
    </form>
  </div>
</div>

<div id="proposal-content" class="hidden">
  <slot />
</div>

<script define:vars={{ proposalId, correctPassword }}>
  const STORAGE_KEY = `proposal_unlocked_${proposalId}`;

  // Check if already unlocked
  function checkUnlocked() {
    const unlocked = sessionStorage.getItem(STORAGE_KEY);
    if (unlocked === 'true') {
      showContent();
    }
  }

  function showContent() {
    document.getElementById('password-prompt')?.classList.add('hidden');
    document.getElementById('proposal-content')?.classList.remove('hidden');
  }

  function showError() {
    document.getElementById('error-message')?.classList.remove('hidden');
  }

  function hideError() {
    document.getElementById('error-message')?.classList.add('hidden');
  }

  // Handle form submission
  document.getElementById('password-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    hideError();

    const input = document.getElementById('password-input');
    const enteredPassword = input?.value;

    if (enteredPassword === correctPassword) {
      sessionStorage.setItem(STORAGE_KEY, 'true');
      showContent();
    } else {
      showError();
      if (input) {
        input.value = '';
        input.focus();
      }
    }
  });

  // Check on page load
  checkUnlocked();
</script>
