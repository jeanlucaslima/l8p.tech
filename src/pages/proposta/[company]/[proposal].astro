---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ProposalHero from '../../../components/ProposalHero.astro';
import TOC from '../../../components/TOC.astro';
import PasswordPrompt from '../../../components/PasswordPrompt.astro';
import ProposalCover from '../../../components/ProposalCover.astro';
import VerticalRibbon from '../../../components/VerticalRibbon.astro';

export async function getStaticPaths() {
  const proposals = await getCollection('proposals');

  return proposals.map((proposal) => {
    // Extract company and filename from the id (e.g., "oracle-latam/plataforma-2025.md")
    const [company, filename] = proposal.id.split('/');
    const proposalSlug = filename.replace('.md', '');

    return {
      params: {
        company,
        proposal: proposalSlug
      },
      props: { proposal },
    };
  });
}

interface Props {
  proposal: CollectionEntry<'proposals'>;
}

const { proposal } = Astro.props;
const { Content, headings } = await proposal.render();

const hasPassword = !!proposal.data.password;
const proposalId = `${Astro.params.company}-${Astro.params.proposal}`;
---

<BaseLayout
  title={`${proposal.data.title} - L8P`}
  description={proposal.data.summary || proposal.data.title}
  hideHeader={true}
>
  <!-- Shared layout component -->
  <PasswordPrompt
    proposalId={proposalId}
    correctPassword={hasPassword ? proposal.data.password! : undefined}
  >
    <!-- Cover page - full viewport with ribbon -->
    <ProposalCover
      client={proposal.data.client}
      date={proposal.data.date}
      consultant={proposal.data.consultant}
    />

    <!-- Document surface: white card on neutral background with TOC sidebar -->
    <div class="mx-auto w-full max-w-7xl sm:px-8 sm:py-16">
      <div class="flex gap-0 sm:gap-4 xl:gap-12">
        <!-- Main content -->
        <div class="flex-1 min-w-0">
          <div class="document-card">
            <!-- Hero Section -->
            <ProposalHero
              title={proposal.data.title}
              subtitle={proposal.data.subtitle}
              consultant={proposal.data.consultant}
              client={proposal.data.client}
              date={proposal.data.date}
              duration={proposal.data.duration}
              proposalId={proposalId}
              hasPassword={hasPassword}
            />

            <!-- Content (H1 will be hidden via CSS) -->
            <article class="prose prose-gray prose-content">
              <Content />
            </article>
          </div>
        </div>

        <!-- TOC sidebar (sticky on right) -->
        {headings.length > 0 && (
          <aside class="toc-sidebar">
            <div class="toc-sticky-wrapper">
              <TOC headings={headings} />
            </div>
          </aside>
        )}
      </div>
    </div>
  </PasswordPrompt>
</BaseLayout>

<style>
  .document-card {
    border-radius: 0;
    border: 0;
    background: white;
    padding: 1rem;
  }

  @media (min-width: 640px) {
    .document-card {
      border-radius: 0.375rem;
      border: 1px solid var(--color-stroke, #E5E5E5);
      padding: 2rem 3rem;
    }
  }

  .prose-content {
    max-width: 72ch;
    margin: 0 auto;
  }

  /* Hide the H1 in content since it's in the hero */
  .prose-content :global(h1) {
    display: none;
  }

  /* Remove the hardcoded metadata section from content */
  .prose-content :global(p:has(strong:first-child)) {
    /* This will hide paragraphs that start with bold text (like "Consultor:") */
    /* We'll handle this more gracefully in content migration */
  }

  .toc-sidebar {
    display: none;
  }

  @media (min-width: 1280px) {
    .toc-sidebar {
      display: block;
      width: 16rem;
      flex-shrink: 0;
    }
  }

  .toc-sticky-wrapper {
    position: sticky;
    top: 6rem;
  }

  @media print {
    .document-card {
      border: 0;
      padding: 0;
    }

    .toc-sidebar {
      display: none;
    }
  }
</style>
