---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ProposalHeader from '../../../components/ProposalHeader.astro';
import ProposalMeta from '../../../components/ProposalMeta.astro';
import TOC from '../../../components/TOC.astro';
import PasswordPrompt from '../../../components/PasswordPrompt.astro';

export async function getStaticPaths() {
  const proposals = await getCollection('proposals');

  return proposals.map((proposal) => {
    // Extract company and filename from the id (e.g., "oracle-latam/plataforma-2025.md")
    const [company, filename] = proposal.id.split('/');
    const proposalSlug = filename.replace('.md', '');

    return {
      params: {
        company,
        proposal: proposalSlug
      },
      props: { proposal },
    };
  });
}

interface Props {
  proposal: CollectionEntry<'proposals'>;
}

const { proposal } = Astro.props;
const { Content, headings } = await proposal.render();

const hasPassword = !!proposal.data.password;
const proposalId = `${Astro.params.company}-${Astro.params.proposal}`;
---

<BaseLayout
  title={`${proposal.data.title} - L8P`}
  description={proposal.data.summary || proposal.data.title}
>
  <ProposalHeader
    title={proposal.data.title}
    proposalId={proposalId}
    hasPassword={hasPassword}
  />

  {hasPassword ? (
    <PasswordPrompt proposalId={proposalId} correctPassword={proposal.data.password!}>
      <!-- Document surface: white card on neutral background with TOC sidebar -->
      <div class="mx-auto w-full max-w-7xl sm:px-8 sm:py-16">
        <div class="flex gap-0 sm:gap-4 xl:gap-12">
          <!-- Main content -->
          <div class="flex-1 min-w-0">
            <div class="rounded-none sm:rounded-sm border-0 sm:border border-gray-200 bg-white px-4 sm:px-8 py-8 sm:py-12 print:border-0 print:p-0">
              <div id="proposal-meta-wrapper">
                <ProposalMeta
                  client={proposal.data.client}
                  date={proposal.data.date}
                  status={proposal.data.status}
                  tags={proposal.data.tags}
                />
              </div>

              <article class="prose prose-gray max-w-none">
                <Content />
              </article>

              <script>
                // Move metadata after the H1 title
                const metaWrapper = document.getElementById('proposal-meta-wrapper');
                const article = document.querySelector('article.prose');
                const firstHeading = article?.querySelector('h1');

                if (firstHeading && metaWrapper) {
                  firstHeading.after(metaWrapper);
                }
              </script>
            </div>
          </div>

          <!-- TOC sidebar (sticky on right) -->
          {headings.length > 0 && (
            <aside class="hidden xl:block w-64 flex-shrink-0 print:hidden">
              <div class="sticky top-24">
                <TOC headings={headings} />
              </div>
            </aside>
          )}
        </div>
      </div>
    </PasswordPrompt>
  ) : (
    <!-- Document surface: white card on neutral background with TOC sidebar -->
    <div class="mx-auto w-full max-w-7xl sm:px-8 sm:py-16">
      <div class="flex gap-0 sm:gap-4 xl:gap-12">
        <!-- Main content -->
        <div class="flex-1 min-w-0">
          <div class="rounded-none sm:rounded-sm border-0 sm:border border-gray-200 bg-white px-4 sm:px-8 py-8 sm:py-12 print:border-0 print:p-0">
            <div id="proposal-meta-wrapper-2">
              <ProposalMeta
                client={proposal.data.client}
                date={proposal.data.date}
                status={proposal.data.status}
                tags={proposal.data.tags}
              />
            </div>

            <article class="prose prose-gray max-w-none">
              <Content />
            </article>

            <script>
              // Move metadata after the H1 title
              const metaWrapper = document.getElementById('proposal-meta-wrapper-2');
              const article = document.querySelector('article.prose');
              const firstHeading = article?.querySelector('h1');

              if (firstHeading && metaWrapper) {
                firstHeading.after(metaWrapper);
              }
            </script>
          </div>
        </div>

        <!-- TOC sidebar (sticky on right) -->
        {headings.length > 0 && (
          <aside class="hidden xl:block w-64 flex-shrink-0 print:hidden">
            <div class="sticky top-24">
              <TOC headings={headings} />
            </div>
          </aside>
        )}
      </div>
    </div>
  )}
</BaseLayout>
